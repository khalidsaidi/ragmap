%%{init: {"theme":"base","themeVariables":{"primaryColor":"#ffffff","primaryTextColor":"#000000","primaryBorderColor":"#000000","lineColor":"#000000","secondaryColor":"#ffffff","tertiaryColor":"#ffffff","clusterBkg":"#ffffff","clusterBorder":"#000000","edgeLabelBackground":"#ffffff"},"flowchart":{"curve":"linear","nodeSpacing":40,"rankSpacing":60}}}%%
flowchart TD
  %% Concept-only diagram (no deployment, framework, or datastore details)

  subgraph S["Sources"]
    direction TB
    Upstream["Official MCP Registry"]:::mono
    Other["Other directories (opt)"]:::mono
    Publisher["Publisher metadata (opt)"]:::mono
    Scheduler["Scheduler trigger (opt)"]:::mono
  end

  subgraph C["MapRag core"]
    direction TB
    Ingest["Ingest + normalize"]:::mono
    Enrich["Enrich + classify"]:::mono
    Index["Catalog + index"]:::mono
    Find["Find + rank + explain"]:::mono
    Ingest --> Enrich --> Index --> Find
  end

  subgraph I["Interfaces"]
    direction TB
    Rest["REST subregistry"]:::mono
    McpRemote["MCP remote (HTTP)"]:::mono
    McpLocal["MCP local (stdio)"]:::mono
    UI["UI"]:::mono
  end

  subgraph U["Who uses it"]
    direction TB
    Agents["Agents"]:::mono
    Humans["Humans"]:::mono
  end

  RagServers["RAG MCP servers (do retrieval)"]:::mono

  %% Sync loop
  Upstream --> Ingest
  Other --> Ingest
  Scheduler --> Ingest
  Publisher --> Enrich

  %% Query loop
  Agents --> McpRemote --> Find
  Agents --> McpLocal --> Find
  Agents --> Rest --> Find
  Humans --> UI --> Find
  Humans --> Rest --> Find

  %% Results
  Find --> Rest
  Find --> McpRemote
  Find --> McpLocal
  Find --> UI

  %% Routing: MapRag returns connect info; agents connect to the chosen server(s).
  Agents --> RagServers
