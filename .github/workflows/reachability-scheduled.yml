name: reachability-scheduled

on:
  schedule:
    # Run every 6 hours at 03:00, 09:00, 15:00, 21:00 UTC.
    # Keeps one run shortly after daily ingest (02:00 UTC) and refreshes through the day.
    - cron: '0 3-21/6 * * *'
  workflow_dispatch:

jobs:
  reachability:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger reachability refresh
        run: |
          set -euo pipefail
          BASE="${{ secrets.API_BASE_URL }}"
          BASE="${BASE%/}"
          echo "API_BASE_URL=$BASE"

          status=0
          code=""
          if ! code=$(curl --fail-with-body -sS -X POST "$BASE/internal/reachability/run" \
            -H "Content-Type: application/json" \
            -H "X-Ingest-Token: ${{ secrets.INGEST_TOKEN }}" \
            -d '{"limit":150}' \
            --max-time 600 \
            -o /tmp/out.json \
            -w "%{http_code}"); then
            status=$?
          fi

          cat /tmp/out.json || true
          echo
          echo "HTTP $code"
          if [[ "$status" -ne 0 ]]; then
            exit "$status"
          fi
