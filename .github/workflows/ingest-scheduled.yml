# Optional: run ingest on a schedule (e.g. daily) without Cloud Scheduler.
# Free for public repos. Add repo secrets: INGEST_TOKEN, API_BASE_URL (Cloud Run URL, not web.app)
name: ingest-scheduled

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger incremental ingest
        run: |
          set -euo pipefail
          BASE="${{ secrets.API_BASE_URL }}"
          BASE="${BASE%/}"
          echo "API_BASE_URL=$BASE"

          status=0
          code=""
          if ! code=$(curl --fail-with-body -sS -X POST "$BASE/internal/ingest/run" \
            -H "Content-Type: application/json" \
            -H "X-Ingest-Token: ${{ secrets.INGEST_TOKEN }}" \
            -d '{"mode":"incremental"}' \
            --max-time 600 \
            -o /tmp/out.json \
            -w "%{http_code}"); then
            status=$?
          fi

          cat /tmp/out.json || true
          echo
          echo "HTTP $code"
          if [[ "$status" -ne 0 ]]; then
            exit "$status"
          fi
